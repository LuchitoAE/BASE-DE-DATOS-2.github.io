<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semana 7 - Procedimientos Almacenados Avanzados</title>
    <link rel="stylesheet" href="../assets/css/global.css"> <!-- Global Design System -->
    <link rel="stylesheet" href="../assets/css/sections/semanas.css"> <!-- Week-specific styles -->
</head>

<body>
    <div class="page-container">
        <header>
            <div class="container">
                <div class="left">
                    <a href="../index.html">INICIO</a>
                </div>
                <div class="right">
                    <a href="../examenfinal.html">Examen Final</a>
                    <a href="../libro/modulo1.html">Libro SQL server</a>
                    <a href="../misdatos.html">Mis datos</a>
                    <a href="../curso.html">Curso</a>
                    <div class="dropdown">
                        <button class="dropbtn">Semanas</button>
                        <div class="dropdown-content">
                            <a href="../semanas/semana1.html">Semana 1</a>
                            <a href="../semanas/semana2.html">Semana 2</a>
                            <a href="../semanas/semana3.html">Semana 3</a>
                            <a href="../semanas/semana4.html">Semana 4</a>
                            <a href="../semanas/semana5.html">Semana 5</a>
                            <a href="../semanas/semana6.html">Semana 6</a>
                            <a href="../semanas/semana7.html">Semana 7</a>
                            <a href="../semanas/semana8.html">Semana 8</a>
                            <a href="../semanas/semana9.html">Semana 9</a>
                            <a href="../semanas/semana10.html">Semana 10</a>
                            <a href="../semanas/semana11.html">Semana 11</a>
                            <a href="../semanas/semana12.html">Semana 12</a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main>
            <div class="content-section">
                <div class="text-block">
                    <h1>Semana 7: Procedimientos Almacenados Avanzados</h1>
                    <h2>游닄 Introducci칩n</h2>
                    <p>
                        Los procedimientos almacenados son uno de los componentes m치s poderosos de SQL Server. Son
                        conjuntos de instrucciones T-SQL
                        precompiladas que se almacenan en la base de datos y pueden ser ejecutadas repetidamente.
                        Ofrecen m칰ltiples ventajas:
                    </p>
                    <ul>
                        <li><strong>Rendimiento:</strong> Se compilan una sola vez y se reutilizan, mejorando el
                            rendimiento</li>
                        <li><strong>Seguridad:</strong> Encapsulan la l칩gica y controlan el acceso a datos</li>
                        <li><strong>Mantenibilidad:</strong> Centralizan la l칩gica de negocio</li>
                        <li><strong>Reducci칩n de tr치fico:</strong> Env칤an solo el nombre del procedimiento en lugar de
                            m칰ltiples consultas</li>
                    </ul>
                </div>
            </div>

            <div class="content-section">
                <div class="text-block">
                    <h2>游댢 Creaci칩n de Procedimientos Almacenados</h2>
                    <h3>Sintaxis B치sica</h3>
                    <pre>CREATE PROCEDURE nombre_procedimiento
    @parametro1 tipo_dato,
    @parametro2 tipo_dato
AS
BEGIN
    -- Instrucciones T-SQL
    SELECT * FROM tabla WHERE columna = @parametro1;
END;</pre>

                    <h3>Ejemplo Pr치ctico: Procedimiento Simple</h3>
                    <p>Crear un procedimiento que liste productos por categor칤a:</p>
                    <pre>CREATE PROCEDURE sp_ListarProductosPorCategoria
    @categoria_id INT
AS
BEGIN
    SELECT 
        p.product_id,
        p.product_name,
        p.list_price,
        c.category_name
    FROM products p
    INNER JOIN categories c ON p.category_id = c.category_id
    WHERE p.category_id = @categoria_id
    ORDER BY p.product_name;
END;

-- Ejecutar el procedimiento
EXEC sp_ListarProductosPorCategoria @categoria_id = 1;</pre>
                </div>
            </div>

            <div class="content-section">
                <div class="text-block">
                    <h2>游꿢 Par치metros de Entrada y Salida</h2>

                    <h3>Par치metros de Entrada</h3>
                    <p>Los par치metros de entrada permiten pasar valores al procedimiento:</p>
                    <pre>CREATE PROCEDURE sp_BuscarCliente
    @nombre VARCHAR(100),
    @apellido VARCHAR(100) = NULL  -- Par치metro opcional
AS
BEGIN
    SELECT * FROM customers
    WHERE first_name LIKE '%' + @nombre + '%'
        AND (@apellido IS NULL OR last_name LIKE '%' + @apellido + '%');
END;

-- Uso
EXEC sp_BuscarCliente @nombre = 'John';
EXEC sp_BuscarCliente @nombre = 'John', @apellido = 'Doe';</pre>

                    <h3>Par치metros de Salida (OUTPUT)</h3>
                    <p>Los par치metros OUTPUT permiten devolver valores desde el procedimiento:</p>
                    <pre>CREATE PROCEDURE sp_ContarProductos
    @categoria_id INT,
    @total INT OUTPUT
AS
BEGIN
    SELECT @total = COUNT(*)
    FROM products
    WHERE category_id = @categoria_id;
END;

-- Uso
DECLARE @cantidad INT;
EXEC sp_ContarProductos @categoria_id = 1, @total = @cantidad OUTPUT;
SELECT @cantidad AS 'Total de Productos';</pre>
                </div>
            </div>

            <div class="content-section">
                <div class="text-block">
                    <h2>丘멆잺 Manejo de Errores con TRY/CATCH</h2>
                    <p>
                        El manejo robusto de errores es esencial en procedimientos almacenados. SQL Server proporciona
                        bloques TRY/CATCH para capturar y manejar errores de forma controlada.
                    </p>

                    <h3>Estructura TRY/CATCH</h3>
                    <pre>CREATE PROCEDURE sp_InsertarProducto
    @nombre VARCHAR(255),
    @marca_id INT,
    @categoria_id INT,
    @precio DECIMAL(10,2),
    @resultado VARCHAR(100) OUTPUT
AS
BEGIN
    BEGIN TRY
        BEGIN TRANSACTION;
        
        -- Validaciones
        IF @precio <= 0
        BEGIN
            RAISERROR('El precio debe ser mayor que cero', 16, 1);
        END
        
        -- Insertar producto
        INSERT INTO products (product_name, brand_id, category_id, list_price)
        VALUES (@nombre, @marca_id, @categoria_id, @precio);
        
        COMMIT TRANSACTION;
        SET @resultado = 'Producto insertado correctamente';
        
    END TRY
    BEGIN CATCH
        IF @@TRANCOUNT > 0
            ROLLBACK TRANSACTION;
        
        SET @resultado = 'Error: ' + ERROR_MESSAGE();
        
        -- Informaci칩n detallada del error
        SELECT 
            ERROR_NUMBER() AS ErrorNumber,
            ERROR_SEVERITY() AS ErrorSeverity,
            ERROR_STATE() AS ErrorState,
            ERROR_PROCEDURE() AS ErrorProcedure,
            ERROR_LINE() AS ErrorLine,
            ERROR_MESSAGE() AS ErrorMessage;
    END CATCH
END;</pre>
                </div>
            </div>

            <div class="content-section">
                <div class="text-block">
                    <h2>游댃 Transacciones en Procedimientos</h2>
                    <p>
                        Las transacciones garantizan que un conjunto de operaciones se ejecuten completamente o no se
                        ejecuten en absoluto,
                        manteniendo la integridad de los datos.
                    </p>

                    <pre>CREATE PROCEDURE sp_ProcesarPedido
    @cliente_id INT,
    @producto_id INT,
    @cantidad INT
AS
BEGIN
    SET NOCOUNT ON;
    
    BEGIN TRY
        BEGIN TRANSACTION;
        
        -- Verificar stock disponible
        DECLARE @stock_actual INT;
        SELECT @stock_actual = quantity
        FROM stocks
        WHERE product_id = @producto_id;
        
        IF @stock_actual < @cantidad
        BEGIN
            RAISERROR('Stock insuficiente', 16, 1);
        END
        
        -- Crear pedido
        INSERT INTO orders (customer_id, order_date, order_status)
        VALUES (@cliente_id, GETDATE(), 1);
        
        DECLARE @order_id INT = SCOPE_IDENTITY();
        
        -- Insertar detalle de pedido
        INSERT INTO order_items (order_id, product_id, quantity, list_price)
        SELECT @order_id, @producto_id, @cantidad, list_price
        FROM products
        WHERE product_id = @producto_id;
        
        -- Actualizar stock
        UPDATE stocks
        SET quantity = quantity - @cantidad
        WHERE product_id = @producto_id;
        
        COMMIT TRANSACTION;
        
        SELECT 'Pedido procesado exitosamente' AS Mensaje, @order_id AS OrderID;
        
    END TRY
    BEGIN CATCH
        IF @@TRANCOUNT > 0
            ROLLBACK TRANSACTION;
        
        THROW;  -- Re-lanzar el error
    END CATCH
END;</pre>
                </div>
            </div>

            <div class="content-section">
                <div class="text-block">
                    <h2>游눠 Best Practices</h2>
                    <ul>
                        <li><strong>Nombrar apropiadamente:</strong> Usar prefijos como <code>sp_</code> o
                            <code>usp_</code>
                        </li>
                        <li><strong>SET NOCOUNT ON:</strong> Evitar mensajes innecesarios de filas afectadas</li>
                        <li><strong>Usar transacciones:</strong> Para operaciones que modifiquen m칰ltiples tablas</li>
                        <li><strong>Validar par치metros:</strong> Siempre validar entradas antes de procesar</li>
                        <li><strong>Documentar:</strong> Incluir comentarios explicativos en el c칩digo</li>
                        <li><strong>Evitar SELECT *:</strong> Especificar columnas expl칤citamente</li>
                        <li><strong>Manejo de errores:</strong> Siempre implementar TRY/CATCH en procedimientos cr칤ticos
                        </li>
                    </ul>
                </div>
            </div>

            <div class="content-section">
                <div class="text-block">
                    <h2>游닇 Ejercicios Pr치cticos</h2>

                    <h3>Ejercicio 1: Procedimiento con M칰ltiples Par치metros</h3>
                    <p>
                        Crear un procedimiento almacenado que actualice el precio de un producto y registre el cambio en
                        una tabla de auditor칤a.
                    </p>

                    <h3>Ejercicio 2: Procedimiento con OUTPUT</h3>
                    <p>
                        Crear un procedimiento que calcule el total de ventas de un cliente espec칤fico y devuelva
                        tanto el total como el n칰mero de pedidos realizados usando par치metros OUTPUT.
                    </p>

                    <h3>Ejercicio 3: Manejo de Errores</h3>
                    <p>
                        Crear un procedimiento que elimine un cliente, pero solo si no tiene pedidos asociados.
                        Debe incluir manejo completo de errores con TRY/CATCH.
                    </p>
                </div>
            </div>

        </main>

        <footer>
            <div class="footer-container">
                <p>&copy; 2026 Luis Walter Aquino Espinoza. Todos los derechos reservados.</p>
                <p>Pol칤tica de Privacidad | T칠rminos de Servicio</p>
            </div>
        </footer>
    </div>
    <script src="../assets/js/theme.js"></script>
</body>

</html>
